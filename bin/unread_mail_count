#!/usr/bin/env python

"""
Fetches current total ammount of unread messages of all accounts from the
Geary mail application database.
"""

import os
import sys
import sqlite3

def geary_root_dir(user):
    return '/home/%s/.local/share/geary' % (user)

def fetch_unread_count(db_path):
    conn = sqlite3.connect(db_path)
    c = conn.execute('SELECT unread_count FROM FolderTable WHERE name="INBOX"')
    return c.fetchone()[0]

def dirs(target_dir):
    return [name for name in os.listdir(target_dir)
            if os.path.isdir(os.path.join(target_dir, name))]

def db_file_path(root_dir, account):
    return root_dir + ('/%s/geary.db' % (account))


if __name__ == '__main__':
  if len(sys.argv) >= 1:
    user = sys.argv[1]
    root_dir = geary_root_dir(user)
    print(sum(fetch_unread_count(db_file_path(root_dir, x))
              for x in dirs(root_dir)))
